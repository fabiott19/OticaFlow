<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Relat√≥rio ‚Äî √ìtica Flow</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @media print{
    #topbar, .no-print{ display:none !important; }
    body{ background:white !important; }
    #totaisMes{ display:block !important; }
  }
  body{ background:#0b1720; color:#e5edf4; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .card{ background:#0f1f2a; border:1px solid rgba(255,255,255,.08) }
  .input{background:#0d1b24;border:1px solid rgba(255,255,255,.08)}
  .tbl th{background:#0f2630}
  #totaisMes{ display:none; }
</style>
</head>
<body>
  <div id="topbar" class="sticky top-0 z-20 bg-black/30 backdrop-blur border-b border-white/10">
    <div class="max-w-6xl mx-auto p-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo-otica-flow.png" class="h-8 w-8 object-contain" alt="√ìtica Flow" />
        <strong>Relat√≥rio ‚Äî √ìtica Flow</strong>
      </div>
      <div class="flex gap-2">
        <button id="btnPrint" class="px-3 py-2 rounded-lg bg-white/90 text-slate-900 font-semibold">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <section class="card rounded-2xl p-5">
      <div class="mb-3">
        <h2 class="font-semibold">Vendas</h2>
        <p class="text-sm opacity-70">Visualize e imprima o relat√≥rio mensal.</p>
      </div>
      <div class="overflow-auto rounded-xl border border-white/10">
        <table class="w-full text-sm tbl">
          <thead>
            <tr class="text-left">
              <th class="p-3">Data</th><th class="p-3">OS</th><th class="p-3">Produtos</th>
              <th class="p-3 text-right">Custo</th><th class="p-3 text-right">Venda</th>
              <th class="p-3 text-right">Taxa</th><th class="p-3 text-right">Lucro</th><th class="p-3">Pagamentos</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <!-- Totais do m√™s (aparece na impress√£o) -->
    <section id="totaisMes" class="p-4 rounded-xl border border-slate-300 bg-white text-slate-900">
      <h3 class="font-bold mb-2">Totais do m√™s</h3>
      <div class="grid grid-cols-3 gap-4 text-lg">
        <div><span class="font-semibold">Custo:</span> <span id="tCusto"></span></div>
        <div><span class="font-semibold">Venda:</span> <span id="tVenda"></span></div>
        <div><span class="font-semibold">Lucro:</span> <span id="tLucro"></span></div>
      </div>
    </section>
  </main>

<script>
  const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
  const parseBRL = (v='') => { if (typeof v === 'number') return v; v=(v+'').replace(/\u00A0/g,' ').replace(/[Rr]\$\s*/g,'').replace(/[^\d.,-]/g,''); if (v.includes(',')&&v.includes('.')) v=v.replace(/\./g,'').replace(',', '.'); else if (v.includes(',')) v=v.replace(',', '.'); const n=parseFloat(v); return Number.isFinite(n)?n:0; };
  const sum = (arr,sel) => arr.reduce((a,x)=>a+sel(x),0);

  const API_URL = "https://script.google.com/macros/s/AKfycbxw3YiUOMHbhXNxSeahLW456uB4T3L4wLjxKUYiMA2bBLCCsTTfllOkd-8KQ_mH8zmG/exec";
  const STORE_KEY = 'otica_flow_sales_v1';
  const loadLocal = () => JSON.parse(localStorage.getItem(STORE_KEY) || '[]');

  async function fetchFromDrive() {
    try { const r = await fetch(API_URL + "?t=" + Date.now(), {cache:"no-store"}); const j = await r.json(); if (j && j.ok && Array.isArray(j.data)) return j.data; } catch(e){}
    return loadLocal();
  }

  function calcSaleTotals(sale) {
    const totVenda = sum(sale.products, p=>+p.price||0);
    const totCusto = sum(sale.products, p=>+p.cost||0);
    const totTaxa  = sum(sale.products, p=>+p.fee||0);
    const lucro = totTaxa - totCusto;
    return {totVenda, totCusto, totTaxa, lucro};
  }

  function sameMonth(d1, d2){
    const a = new Date(d1), b = new Date(d2);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth();
  }

  async function render(){
    const sales = await fetchFromDrive();
    const now = new Date();
    const monthSales = sales.filter(s=> s.date && sameMonth(s.date, now));
    const rows = document.getElementById('rows');
    rows.innerHTML = '';

    for (const s of monthSales){
      const t = calcSaleTotals(s);
      const tr = document.createElement('tr');
      tr.className = 'border-t border-white/10';
      tr.innerHTML = `
        <td class="p-3">${s.date||''}</td>
        <td class="p-3">${s.os||''}</td>
        <td class="p-3">${s.products.map(p=>p.name).join(', ')}</td>
        <td class="p-3 text-right">${fmt.format(t.totCusto)}</td>
        <td class="p-3 text-right">${fmt.format(t.totVenda)}</td>
        <td class="p-3 text-right">${fmt.format(t.totTaxa)}</td>
        <td class="p-3 text-right">${fmt.format(t.lucro)}</td>
        <td class="p-3">${s.payments.map(p=>p.method+' '+(p.detail||'')+': '+fmt.format(+p.amount||0)).join(' ‚Ä¢ ')}</td>`;
      rows.appendChild(tr);
    }

    // Totais do m√™s para a impress√£o
    const totVenda = sum(monthSales, s=>calcSaleTotals(s).totVenda);
    const totCusto = sum(monthSales, s=>calcSaleTotals(s).totCusto);
    const totTaxa  = sum(monthSales, s=>calcSaleTotals(s).totTaxa);
    const lucro    = totTaxa - totCusto;
    document.getElementById('tCusto').textContent = fmt.format(totCusto);
    document.getElementById('tVenda').textContent = fmt.format(totVenda);
    document.getElementById('tLucro').textContent = fmt.format(lucro);
  }

  document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
  window.addEventListener('load', render);
</script>
</body>
</html>

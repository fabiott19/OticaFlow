<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ótica Flow - Relatório</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen p-4">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center">
      <img src="logo.png" alt="Logo" class="w-8 h-8 mr-2">
      <h1 class="text-xl font-semibold">Relatório de Vendas</h1>
    </div>
    <a href="index.html" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">⬅️ Voltar</a>
  </div>

  <table id="tabela" class="w-full text-left border-collapse">
    <thead class="bg-slate-800">
      <tr>
        <th class="p-2">Data</th>
        <th class="p-2">Cliente</th>
        <th class="p-2">Pagamento</th>
        <th class="p-2">Parcelas</th>
        <th class="p-2">Valor</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-700 bg-slate-800"></tbody>
  </table>

  <p id="totais" class="text-center text-gray-400 mt-4"></p>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxw3YiUOMHbhXNxSeahLW456uB4T3L4wLjxKUYiMA2bBLCCsTTfllOkd-8KQ_mH8zmG/exec";

    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cbName = "cb_" + Date.now() + Math.random().toString(16).slice(2);
        const s = document.createElement("script");
        s.src = url + (url.includes("?")?"&":"?") + "callback=" + cbName;
        window[cbName] = data => { resolve(data); s.remove(); delete window[cbName]; };
        s.onerror = reject;
        document.body.appendChild(s);
      });
    }

    function fromCentavos(c){ return (c/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
    function fmtData(iso){ return iso ? new Date(iso).toLocaleDateString('pt-BR') : "-"; }

    async function carregar(){
      try {
        const res = await jsonp(API_URL + "?t=" + Date.now());
        if(!res.ok) throw new Error(res.error || "Erro ao carregar");
        const vendas = res.data || [];
        const tbody = document.querySelector("#tabela tbody");
        tbody.innerHTML = "";
        let total = 0;
        vendas.forEach(v=>{
          total += v.valorCentavos || 0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="p-2">${fmtData(v.data)}</td>
            <td class="p-2">${v.cliente}</td>
            <td class="p-2">${v.pagamento}</td>
            <td class="p-2">${v.parcelas}</td>
            <td class="p-2">${fromCentavos(v.valorCentavos)}</td>`;
          tbody.appendChild(tr);
        });
        document.getElementById("totais").textContent = `Vendas: ${vendas.length} | Total: ${fromCentavos(total)}`;
      } catch(err){
        console.error(err);
        document.getElementById("totais").textContent = "Erro ao carregar dados.";
      }
    }

    carregar();
  </script>
</body>
</html>

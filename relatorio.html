<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Relat√≥rio ‚Äì √ìtica Flow</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @media print{
    #topbar, .no-print{ display:none !important; }
    body{ background:white !important; color:#111 !important; }
    #totaisMes{ display:block !important; }
    table{ page-break-inside:auto }
    tr{ page-break-inside:avoid; page-break-after:auto }
  }
  body{ background:#0b1720; color:#e5edf4; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .card{ background:#0f1f2a; border:1px solid rgba(255,255,255,.08) }
  .tbl th{background:#0f2630}
  #totaisMes{ display:none; }
</style>
</head>
<body>
  <div id="topbar" class="sticky top-0 z-20 bg-black/30 backdrop-blur border-b border-white/10">
    <div class="max-w-6xl mx-auto p-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo-otica-flow.png" class="h-8 w-8 object-contain" alt="√ìtica Flow" />
        <strong>Relat√≥rio ‚Äì √ìtica Flow</strong>
      </div>
      <div class="flex gap-2">
        <a href="index.html" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">‚Üê Voltar</a>
        <button id="btnPrint" class="px-3 py-2 rounded-lg bg-white/90 text-slate-900 font-semibold">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <section class="card rounded-2xl p-5">
      <div class="mb-3">
        <h2 class="font-semibold">Vendas</h2>
        <p class="text-sm opacity-70">Visualize e imprima o relat√≥rio mensal.</p>
      </div>
      
      <div class="mb-4 flex items-center gap-3 no-print">
        <label class="text-sm font-medium">Filtrar por per√≠odo:</label>
        <select id="filterMonth" class="px-3 py-2 rounded-lg bg-slate-700 border border-white/10">
          <option value="current">M√™s atual</option>
        </select>
      </div>
      
      <div class="overflow-auto rounded-xl border border-white/10">
        <table class="w-full text-sm tbl">
          <thead>
            <tr class="text-left">
              <th class="p-3">Data</th><th class="p-3">OS</th><th class="p-3">Produtos</th>
              <th class="p-3 text-right">Custo</th><th class="p-3 text-right">Venda</th>
              <th class="p-3 text-right">Taxa</th><th class="p-3 text-right">Lucro</th><th class="p-3">Pagamentos</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <section id="totaisMes" class="p-4 rounded-xl border border-slate-300 bg-white text-slate-900">
      <h3 class="font-bold mb-2">Totais do per√≠odo</h3>
      <div class="grid grid-cols-4 gap-4 text-lg">
        <div><span class="font-semibold">Custo:</span> <span id="tCusto"></span></div>
        <div><span class="font-semibold">Venda:</span> <span id="tVenda"></span></div>
        <div><span class="font-semibold">Taxa:</span> <span id="tTaxa"></span></div>
        <div><span class="font-semibold">Lucro:</span> <span id="tLucro"></span></div>
      </div>
    </section>
  </main>

<script>
  const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
  const sum = (arr,sel) => arr.reduce((a,x)=>a+sel(x),0);
  const STORE_KEY = 'otica_flow_sales_v1';

  const loadLocal = () => {
    try {
      const data = localStorage.getItem(STORE_KEY);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      console.error('[v0] Relat√≥rio - erro ao carregar localStorage:', e);
      return [];
    }
  };

  // NOVO: Fun√ß√£o para formatar a data para dd/mm/aaaa
  const formatDate = (dateStr) => {
      if (!dateStr) return '';
      // Assume que a data est√° no formato yyyy-mm-dd
      const [year, month, day] = dateStr.split('-');
      return day && month && year ? `${day}/${month}/${year}` : dateStr;
  };
  
  // Fun√ß√£o ajustada para garantir que a compara√ß√£o de datas funcione corretamente
  const parseDate = (dateStr) => { 
      if (!dateStr) return null;
      // Assume-se o formato yyyy-mm-dd
      const d = new Date(dateStr + 'T00:00:00'); // Adiciona T00:00:00 para evitar problemas de fuso hor√°rio
      if (!isNaN(d.getTime())) return d;
      return null;
  };

  function calcSaleTotals(sale) {
    const totVenda = (sale.products||[]).reduce((a,p)=>a+(+p.price||0),0);
    const totCusto = (sale.products||[]).reduce((a,p)=>a+(+p.cost||0),0);
    const totTaxa  = (sale.products||[]).reduce((a,p)=>a+(+p.fee||0),0);
    const lucro = totTaxa - totCusto;
    return {totVenda, totCusto, totTaxa, lucro};
  }
  
  function sameMonth(d1, d2){
    const a = parseDate(d1);
    const b = d2 instanceof Date ? d2 : parseDate(d2);
    if (!a || !b) return false;
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth();
  }
  
  // Fun√ß√£o de compara√ß√£o para ordena√ß√£o: mais recente primeiro
  const compareDates = (a, b) => {
      const dateA = parseDate(a.date);
      const dateB = parseDate(b.date);
      
      if (!dateA && !dateB) return 0;
      if (!dateA) return 1; 
      if (!dateB) return -1; 
      
      return dateB.getTime() - dateA.getTime(); // Mais recente primeiro
  };

  function populateMonthFilter(sales) {
    const monthsSet = new Set();
    sales.forEach(s => {
      if (s.date) {
        const d = parseDate(s.date);
        if (d && !isNaN(d.getTime())) {
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          monthsSet.add(key);
        }
      }
    });
    
    // Ordena os meses do mais recente para o mais antigo
    const months = Array.from(monthsSet).sort().reverse(); 
    const select = document.getElementById('filterMonth');
    
    // Limpa op√ß√µes antigas (mant√©m apenas "M√™s atual")
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    // Adiciona os meses dispon√≠veis
    months.forEach(m => {
      const [year, month] = m.split('-');
      const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      const label = `${monthNames[parseInt(month)-1]} ${year}`;
      const option = new Option(label, m);
      
      // Adiciona apenas se n√£o for o mesmo m√™s/ano que o "M√™s atual" (para evitar repeti√ß√£o)
      const now = new Date();
      const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      if (m !== currentMonthKey) {
        select.add(option);
      }
    });
  }

  async function render(){
    const sales = loadLocal();
    console.log('[v0] Relat√≥rio - renderizando', sales.length, 'vendas');
    
    // Popular o filtro com os meses dispon√≠veis
    populateMonthFilter(sales);
    
    const rows = document.getElementById('rows');
    rows.innerHTML = '';

    const filterValue = document.getElementById('filterMonth').value;
    let filteredSales;
    
    if (filterValue === 'current') {
      const now = new Date();
      filteredSales = sales.filter(s=> s.date && sameMonth(s.date, now));
    } else {
      const [year, month] = filterValue.split('-');
      filteredSales = sales.filter(s => {
        if (!s.date) return false;
        const d = parseDate(s.date);
        if (!d || isNaN(d.getTime())) return false;
        return d.getFullYear() === parseInt(year) && d.getMonth() === parseInt(month) - 1;
      });
    }
    
    // Ordena as vendas filtradas
    filteredSales.sort(compareDates);

    for (const s of filteredSales){
      const t = calcSaleTotals(s);
      const payStr = (s.payments||[]).map(p=>{
        const parc = p.installments ? ` ${p.installments}` : '';
        return `${p.method}${parc}: ${fmt.format(+p.amount||0)}`;
      }).join(' ‚Ä¢ ');
      const tr = document.createElement('tr');
      tr.className = 'border-t border-white/10';
      tr.innerHTML = `
        <td class="p-3">${formatDate(s.date||'')}</td>
        <td class="p-3">${s.os||''}</td>
        <td class="p-3">${(s.products||[]).map(p=>p.name).join(', ')}</td>
        <td class="p-3 text-right">${fmt.format(t.totCusto)}</td>
        <td class="p-3 text-right">${fmt.format(t.totVenda)}</td>
        <td class="p-3 text-right">${fmt.format(t.totTaxa)}</td>
        <td class="p-3 text-right">${fmt.format(t.lucro)}</td>
        <td class="p-3">${payStr}</td>`;
      rows.appendChild(tr);
    }

    const tVenda = sum(filteredSales, s=>calcSaleTotals(s).totVenda);
    const tCusto = sum(filteredSales

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RelatÃ³rio de Vendas â€” Ã“tica Flow</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://raw.githubusercontent.com/SEU_USUARIO/SEU_REPO/main/logo.png" type="image/png" />
  <style>
    :root{--bg:#0b1720;--teal:#94d2bd}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#0f2430)}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px)}
    .card{background:#0f1f2a;border:1px solid rgba(255,255,255,.08)}
    .chip{border:1px solid rgba(255,255,255,.18)}
    .btn{transition:transform .06s ease}
    .btn:active{transform:translateY(1px)}
    .input{background:#0d1b24;border:1px solid rgba(255,255,255,.08)}
    .tbl th{background:#0f2630}
    #splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0c1822;z-index:50;transition:opacity .3s ease}
    #splash.hide{opacity:0;pointer-events:none}
  </style>
</head>
<body class="text-slate-100">

  <!-- Splash -->
  <div id="splash">
    <div class="flex flex-col items-center gap-4">
      <img src="https://raw.githubusercontent.com/SEU_USUARIO/SEU_REPO/main/logo.png" alt="Ã“tica Flow" class="h-20 w-20 object-contain" />
      <p class="text-sm opacity-70">Carregando Ã“tica Flowâ€¦</p>
    </div>
  </div>

  <header class="sticky top-0 z-30 glass border-b border-white/10">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/SEU_USUARIO/SEU_REPO/main/logo.png" alt="Ã“tica Flow" class="h-8 w-8 object-contain" />
        <h1 class="text-lg font-semibold tracking-tight">RelatÃ³rio de Vendas â€” Ã“tica Flow</h1>
      </div>
      <nav class="flex items-center gap-2">
        <button id="btnNew" class="btn px-3 py-2 rounded-xl bg-[var(--teal)] text-slate-900 font-semibold">Editar venda</button>
        <button id="btnExport" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Exportar</button>
        <label for="importFile" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 cursor-pointer">Importar</label>
        <input type="file" id="importFile" accept="application/json" class="hidden" />
        <a id="btnReport" href="index.html" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">ðŸ“Š RelatÃ³rio</a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-7xl p-4 grid gap-6">
    <section class="card rounded-2xl p-5">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="rounded-2xl p-4 chip bg-white/5"><p class="text-xs opacity-70">Vendas</p><p id="kpiQtd" class="text-2xl font-semibold">0</p></div>
        <div class="rounded-2xl p-4 chip bg-white/5"><p class="text-xs opacity-70">Faturamento</p><p id="kpiFat" class="text-2xl font-semibold">R$ 0,00</p></div>
        <div class="rounded-2xl p-4 chip bg-white/5"><p class="text-xs opacity-70">Taxas</p><p id="kpiTax" class="text-2xl font-semibold">R$ 0,00</p></div>
        <div class="rounded-2xl p-4 chip bg-white/5"><p class="text-xs opacity-70">Lucro (Taxa âˆ’ Custo)</p><p id="kpiLucro" class="text-2xl font-semibold">R$ 0,00</p></div>
      </div>
    </section>

    <section class="card rounded-2xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Ãšltimas vendas</h2>
        <a href="index.html" class="btn px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Voltar ao sistema â†’</a>
      </div>
      <div class="overflow-auto rounded-xl border border-white/10">
        <table class="w-full text-sm tbl">
          <thead><tr class="text-left">
            <th class="p-3">Data</th><th class="p-3">OS</th><th class="p-3">Produtos</th>
            <th class="p-3 text-right">Custo</th><th class="p-3 text-right">Venda</th>
            <th class="p-3 text-right">Taxa</th><th class="p-3 text-right">Lucro</th><th class="p-3">Pagamento</th><th class="p-3">AÃ§Ãµes</th>
          </tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL custom -->
  <div id="saleModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-40">
    <div class="card rounded-3xl p-5 w-[min(980px,95vw)] text-slate-100">
      <div class="flex items-start justify-between gap-3">
        <div><h2 id="dlgTitle" class="text-xl font-semibold">Editar venda</h2><p class="text-sm opacity-70">Cadastre uma venda com mÃºltiplos produtos e divisÃ£o de pagamentos.</p></div>
        <button type="button" id="dlgClose" class="btn px-3 py-1.5 rounded-xl bg-slate-700 hover:bg-slate-600">Fechar</button>
      </div>
      <form id="saleForm" class="mt-4">
        <div class="grid md:grid-cols-4 gap-4">
          <div><label class="text-sm opacity-80">OS</label><input name="os" required class="input w-full rounded-xl px-3 py-2" placeholder="Ex: 228" /></div>
          <div><label class="text-sm opacity-80">Data</label><input name="date" type="date" required class="input w-full rounded-xl px-3 py-2" /></div>
          <div class="md:col-span-2"><label class="text-sm opacity-80">ObservaÃ§Ãµes (opcional)</label><input name="notes" class="input w-full rounded-xl px-3 py-2" /></div>
        </div>

        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Produtos</h3>
            <button type="button" id="addProduct" class="btn px-3 py-1.5 rounded-xl bg-[var(--teal)] text-slate-900 font-semibold">+ Adicionar produto</button>
          </div>
          <div class="mt-3 overflow-auto rounded-xl border border-white/10">
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="p-3">Produto</th><th class="p-3 w-32">Custo</th><th class="p-3 w-32">Venda</th><th class="p-3 w-32">Taxa</th><th class="p-3 w-24">Lucro</th><th class="p-3 w-10"></th></tr></thead>
              <tbody id="prodRows"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Pagamentos (pode dividir)</h3>
            <button type="button" id="addPayment" class="btn px-3 py-1.5 rounded-xl bg-[var(--teal)] text-slate-900 font-semibold">+ Adicionar pagamento</button>
          </div>
          <div class="mt-3 overflow-auto rounded-xl border border-white/10">
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="p-3">Forma</th><th class="p-3">Detalhe</th><th class="p-3 w-32">Valor</th><th class="p-3 w-10"></th></tr></thead>
              <tbody id="payRows"></tbody>
            </table>
          </div>
          <p id="splitHint" class="mt-2 text-xs opacity-70">A soma dos pagamentos deve ser igual ao total de <span class="font-semibold" id="totalVendaHint">R$ 0,00</span>.</p>
        </div>

        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-2xl p-4 chip bg-white/5"><p class="text-xs opacity-70">Total Custo</p><p id="totCusto" class="text-xl font-semibold">R$ 0,00</p></div>
          <div class="rounded-2xl p-4 chip bg-white/5"><p class="text-xs opacity-70">Total Venda</p><p id="totVenda" class="text-xl font-semibold">R$ 0,00</p></div>
          <div class="rounded-2xl p-4 chip bg-white/5"><p class="text-xs opacity-70">Total Taxa</p><p id="totTaxa" class="text-xl font-semibold">R$ 0,00</p></div>
          <div class="rounded-2xl p-4 chip bg-white/5"><p class="text-xs opacity-70">Lucro (Taxa âˆ’ Custo)</p><p id="totLucro" class="text-xl font-semibold">R$ 0,00</p></div>
        </div>

        <div class="mt-6 flex items-center justify-end gap-3">
          <button type="button" id="btnDelete" class="hidden btn px-4 py-2 rounded-xl bg-red-600">Excluir</button>
          <button type="submit" id="btnSave" class="btn px-4 py-2 rounded-xl bg-[var(--teal)] text-slate-900 font-semibold">Salvar alteraÃ§Ãµes</button>
        </div>
      </form>
    </div>
  </div>

  <template id="tplProduct"><tr><td class="p-2"><input name="name" required class="input w-full rounded-lg px-2 py-1.5" placeholder="Ex: Lente Poli AR" /></td><td class="p-2"><input name="cost" inputmode="numeric" class="input w-full rounded-lg px-2 py-1.5 text-right" placeholder="0,00" /></td><td class="p-2"><input name="price" inputmode="numeric" class="input w-full rounded-lg px-2 py-1.5 text-right" placeholder="0,00" /></td><td class="p-2"><input name="fee" inputmode="numeric" class="input w-full rounded-lg px-2 py-1.5 text-right" placeholder="0,00" /></td><td class="p-2 text-right"><span class="lucro">R$ 0,00</span></td><td class="p-2 text-right"><button type="button" class="btn delRow px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600">âœ•</button></td></tr></template>

  <template id="tplPayment"><tr><td class="p-2"><select name="method" class="input w-full rounded-lg px-2 py-1.5"><option>Dinheiro</option><option>Pix</option><option>DÃ©bito</option><option>CrÃ©dito</option></select></td><td class="p-2"><select name="detail" class="input w-full rounded-lg px-2 py-1.5"><option value="Ã  vista">Ã  vista</option><option value="2x">2x</option><option value="3x">3x</option><option value="4x">4x</option><option value="5x">5x</option><option value="6x">6x</option><option value="7x">7x</option><option value="8x">8x</option><option value="9x">9x</option><option value="10x">10x</option></select></td><td class="p-2"><input name="amount" inputmode="numeric" class="input w-full rounded-lg px-2 py-1.5 text-right" placeholder="0,00" /></td><td class="p-2 text-right"><button type="button" class="btn delRow px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600">âœ•</button></td></tr></template>

  <script>
    // Helpers
    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fnum = new Intl.NumberFormat('pt-BR');
    const parseBRL = (v='') => { if (typeof v === 'number') return v; v=(v+'').replace(/[^\\d,.-]/g,'').replace(/\\./g,'').replace(',', '.'); const n=parseFloat(v); return isNaN(n)?0:n; };
    const sum = (arr,sel) => arr.reduce((a,x)=>a+sel(x),0);

    // Storage
    const STORE_KEY = 'otica_flow_sales_v1';
    const loadSales = () => JSON.parse(localStorage.getItem(STORE_KEY) || '[]');
    const saveSales = (arr) => localStorage.setItem(STORE_KEY, JSON.stringify(arr));

    // Estado
    let sales = loadSales();
    let editingId = null;

    // Elements
    const rows = document.querySelector('#rows');
    const saleModal = document.querySelector('#saleModal');
    const form = document.querySelector('#saleForm');
    const btnDelete = document.querySelector('#btnDelete');
    const btnNew = document.querySelector('#btnNew');
    const btnExport = document.querySelector('#btnExport');
    const importFile = document.querySelector('#importFile');
    const prodRows = document.querySelector('#prodRows');
    const payRows = document.querySelector('#payRows');
    const totals = {
      custo: document.querySelector('#totCusto'),
      venda: document.querySelector('#totVenda'),
      taxa: document.querySelector('#totTaxa'),
      lucro: document.querySelector('#totLucro'),
      vendaHint: document.querySelector('#totalVendaHint'),
      kpiQtd: document.querySelector('#kpiQtd'),
      kpiFat: document.querySelector('#kpiFat'),
      kpiTax: document.querySelector('#kpiTax'),
      kpiLucro: document.querySelector('#kpiLucro')
    };

    // Core
    const calcSaleTotals = (sale) => {
      const totVenda = sum(sale.products, p=>+p.price||0);
      const totCusto = sum(sale.products, p=>+p.cost||0);
      const totTaxa  = sum(sale.products, p=>+p.fee||0);
      const lucro = totTaxa - totCusto; // pedido: Lucro = Taxa - Custo
      return {totVenda, totCusto, totTaxa, lucro};
    };

    function refreshKPIs(){
      const list = sales.slice(0,20);
      const totFat = sum(list, s=>calcSaleTotals(s).totVenda);
      const totTax = sum(list, s=>calcSaleTotals(s).totTaxa);
      const totLuc = sum(list, s=>calcSaleTotals(s).lucro);
      totals.kpiQtd.textContent = fnum.format(sales.length);
      totals.kpiFat.textContent = fmt.format(totFat);
      totals.kpiTax.textContent = fmt.format(totTax);
      totals.kpiLucro.textContent = fmt.format(totLuc);
    }

    function render(){
      rows.innerHTML = '';
      const list = sales.slice(0,20);
      for (const s of list){
        const t = calcSaleTotals(s);
        const tr = document.createElement('tr');
        tr.className = 'border-t border-white/10 hover:bg-white/5';
        const prodNames = s.products.map(p=>p.name).join(', ');
        const payStr = s.payments.map(p=> (p.method + (p.method==='CrÃ©dito'?' '+p.detail:'') + ': ' + fmt.format(+p.amount||0))).join(' â€¢ ');
        tr.innerHTML = [
          '<td class="p-3 whitespace-nowrap">', (s.date||''), '</td>',
          '<td class="p-3">', (s.os||''), '</td>',
          '<td class="p-3">', prodNames, '</td>',
          '<td class="p-3 text-right">', fmt.format(t.totCusto), '</td>',
          '<td class="p-3 text-right">', fmt.format(t.totVenda), '</td>',
          '<td class="p-3 text-right">', fmt.format(t.totTaxa), '</td>',
          '<td class="p-3 text-right">', fmt.format(t.lucro), '</td>',
          '<td class="p-3">', payStr, '</td>',
          '<td class="p-3"><div class="flex gap-2">',
            '<button class="btn px-2 py-1 rounded-lg bg-slate-700 hover:bg-slate-600" data-edit="', s.id ,'">Editar</button>',
            '<button class="btn px-2 py-1 rounded-lg bg-red-600/80 hover:bg-red-600" data-del="', s.id ,'">Excluir</button>',
          '</div></td>'
        ].join('');
        rows.appendChild(tr);
      }
      refreshKPIs();
    }

    function toBRL(v){
      if (v===undefined || v===null || v==='') return '';
      const n = typeof v==='number'? v : parseFloat(v);
      if (isNaN(n)) return '';
      return fmt.format(n).replace(/^R\\$\\s?/, '');
    }

    function addProductRow(p={name:'',cost:'',price:'',fee:''}){
      const tpl = document.querySelector('#tplProduct').content.firstElementChild.cloneNode(true);
      const name = tpl.querySelector('[name=name]');
      const cost = tpl.querySelector('[name=cost]');
      const price = tpl.querySelector('[name=price]');
      const fee = tpl.querySelector('[name=fee]');
      const lucroEl = tpl.querySelector('.lucro');
      name.value = p.name||''; cost.value = toBRL(p.cost); price.value = toBRL(p.price); fee.value = toBRL(p.fee);
      const recalc = ()=>{ lucroEl.textContent = fmt.format(parseBRL(fee.value) - parseBRL(cost.value)); updateTotalsFromForm(); };
      [cost,price,fee].forEach(el=> el.addEventListener('input', recalc));
      tpl.querySelector('.delRow').addEventListener('click', ()=>{ tpl.remove(); updateTotalsFromForm(); });
      prodRows.appendChild(tpl);
      recalc();
    }

    function addPaymentRow(p={method:'Dinheiro', detail:'Ã  vista', amount:''}){
      const tpl = document.querySelector('#tplPayment').content.firstElementChild.cloneNode(true);
      const method = tpl.querySelector('[name=method]');
      const detail = tpl.querySelector('[name=detail]');
      const amount = tpl.querySelector('[name=amount]');
      method.value = p.method||'Dinheiro';
      detail.value = p.detail||'Ã  vista';
      amount.value = toBRL(p.amount);
      const toggleDetail = ()=>{ detail.disabled = method.value !== 'CrÃ©dito'; detail.classList.toggle('opacity-40', detail.disabled); };
      toggleDetail();
      method.addEventListener('change', toggleDetail);
      amount.addEventListener('input', updateTotalsFromForm);
      tpl.querySelector('.delRow').addEventListener('click', ()=>{ tpl.remove(); updateTotalsFromForm(); });
      payRows.appendChild(tpl);
    }

    function formToSale(){
      const products = Array.from(document.querySelectorAll('#prodRows tr')).map(tr=> ({
        name: tr.querySelector('[name=name]').value.trim(),
        cost: parseBRL(tr.querySelector('[name=cost]').value),
        price: parseBRL(tr.querySelector('[name=price]').value),
        fee: parseBRL(tr.querySelector('[name=fee]').value),
      })).filter(p=>p.name);
      const payments = Array.from(document.querySelectorAll('#payRows tr')).map(tr=> ({
        method: tr.querySelector('[name=method]').value,
        detail: tr.querySelector('[name=detail]').value,
        amount: parseBRL(tr.querySelector('[name=amount]').value),
      })).filter(p=>p.amount>0);
      return {
        id: editingId || crypto.randomUUID(),
        os: form.os.value.trim(),
        date: form.date.value,
        notes: form.notes.value.trim(),
        products, payments,
      };
    }

    function updateTotalsFromForm(){
      const s = formToSale();
      const t = calcSaleTotals(s);
      totals.custo.textContent = fmt.format(t.totCusto);
      totals.venda.textContent = fmt.format(t.totVenda);
      totals.taxa.textContent = fmt.format(t.totTaxa);
      totals.lucro.textContent = fmt.format(t.lucro);
      if (totals.vendaHint) totals.vendaHint.textContent = fmt.format(t.totVenda);
      const split = sum(s.payments, p=>+p.amount||0);
      const ok = Math.abs(split - t.totVenda) < 0.01;
      const hint = document.querySelector('#splitHint');
      if (hint) hint.classList.toggle('text-red-400', !ok);
      return ok;
    }

    // Modal helpers (custom)
    function openModal(){
      saleModal.classList.remove('hidden');
      saleModal.classList.add('flex');
    }
    function closeModal(){
      saleModal.classList.add('hidden');
      saleModal.classList.remove('flex');
    }

    // Events
    document.getElementById('dlgClose').addEventListener('click', closeModal);
    document.getElementById('addProduct').addEventListener('click', ()=> addProductRow());
    document.getElementById('addPayment').addEventListener('click', ()=> addPaymentRow());
    document.getElementById('btnNew').addEventListener('click', ()=>{
      editingId=null; form.reset(); prodRows.innerHTML=''; payRows.innerHTML='';
      addProductRow(); addPaymentRow();
      try { form.date.valueAsDate = new Date(); } catch(e) {}
      updateTotalsFromForm(); openModal();
    });

    form.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      if (!updateTotalsFromForm() && !confirm('A soma dos pagamentos Ã© diferente do total de venda. Deseja salvar mesmo assim?')) return;
      const sale = formToSale();
      const i = sales.findIndex(s=>s.id===sale.id);
      if (i>=0) sales[i]=sale; else sales.unshift(sale);
      saveSales(sales); render(); closeModal();
    });

    btnDelete.addEventListener('click', ()=>{
      if (!editingId) return;
      if (!confirm('Excluir esta venda?')) return;
      sales = sales.filter(s=>s.id!==editingId);
      saveSales(sales); render(); closeModal();
    });

    rows.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.edit || btn.dataset.del;
      const sale = sales.find(s=>s.id===id);
      if (btn.dataset.edit){
        editingId = sale.id;
        form.reset(); prodRows.innerHTML=''; payRows.innerHTML='';
        form.os.value = sale.os||''; form.date.value = sale.date||''; form.notes.value = sale.notes||'';
        sale.products.forEach(p=> addProductRow(p));
        sale.payments.forEach(p=> addPaymentRow(p));
        updateTotalsFromForm(); openModal();
      } else if (btn.dataset.del){
        if (confirm('Excluir esta venda?')){ sales = sales.filter(s=>s.id!==id); saveSales(sales); render(); }
      }
    });

    // Export/Import
    btnExport.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(sales, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'vendas_otica_flow.json'; a.click();
    });
    importFile.addEventListener('change', async ()=>{
      const f = importFile.files?.[0]; if (!f) return;
      const text = await f.text();
      try { const data = JSON.parse(text); if(!Array.isArray(data)) throw 0; sales = data; saveSales(sales); render(); alert('Importado com sucesso!'); }
      catch { alert('Arquivo invÃ¡lido.'); }
      finally { importFile.value=''; }
    });

    // Splash
    function hideSplash(){ const sp = document.getElementById('splash'); if (!sp) return; sp.classList.add('hide'); setTimeout(()=>{sp.style.display='none';}, 300); }
    window.addEventListener('load', hideSplash);
    setTimeout(hideSplash, 1200);

    // Init
    render();
  </script>
</body>
</html>

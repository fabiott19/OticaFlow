<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Relat√≥rio ‚Äì √ìtica Flow</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @media print{
    #topbar, .no-print{ display:none !important; }
    body{ background:white !important; color:#111 !important; }
    #totaisMes{ display:block !important; }
    table{ page-break-inside:auto }
    tr{ page-break-inside:avoid; page-break-after:auto }
  }
  body{ background:#0b1720; color:#e5edf4; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .card{ background:#0f1f2a; border:1px solid rgba(255,255,255,.08) }
  .tbl th{background:#0f2630}
  #totaisMes{ display:none; }
</style>
</head>
<body>
  <div id="topbar" class="sticky top-0 z-20 bg-black/30 backdrop-blur border-b border-white/10">
    <div class="max-w-6xl mx-auto p-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo-otica-flow.png" class="h-8 w-8 object-contain" alt="√ìtica Flow" />
        <strong>Relat√≥rio ‚Äì √ìtica Flow</strong>
      </div>
      <div class="flex gap-2">
        <a href="index.html" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">‚Üê Voltar</a>
        <button id="btnPrint" class="px-3 py-2 rounded-lg bg-white/90 text-slate-900 font-semibold">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <section class="card rounded-2xl p-5">
      <div class="mb-3">
        <h2 class="font-semibold">Vendas</h2>
        <p class="text-sm opacity-70">Visualize e imprima o relat√≥rio mensal.</p>
      </div>
      <div class="overflow-auto rounded-xl border border-white/10">
        <table class="w-full text-sm tbl">
          <thead>
            <tr class="text-left">
              <th class="p-3">Data</th><th class="p-3">OS</th><th class="p-3">Produtos</th>
              <th class="p-3 text-right">Custo</th><th class="p-3 text-right">Venda</th>
              <th class="p-3 text-right">Taxa</th><th class="p-3 text-right">Lucro</th><th class="p-3">Pagamentos</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <!-- Totais do m√™s (aparece na impress√£o) -->
    <section id="totaisMes" class="p-4 rounded-xl border border-slate-300 bg-white text-slate-900">
      <h3 class="font-bold mb-2">Totais do m√™s</h3>
      <div class="grid grid-cols-3 gap-4 text-lg">
        <div><span class="font-semibold">Custo:</span> <span id="tCusto"></span></div>
        <div><span class="font-semibold">Venda:</span> <span id="tVenda"></span></div>
        <div><span class="font-semibold">Lucro:</span> <span id="tLucro"></span></div>
      </div>
    </section>
  </main>

<script>
  const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
  const sum = (arr,sel) => arr.reduce((a,x)=>a+sel(x),0);
  const API_URL = "https://script.google.com/macros/s/AKfycbxw3YiUOMHbhXNxSeahLW456uB4T3L4wLjxKUYiMA2bBLCCsTTfllOkd-8KQ_mH8zmG/exec";
  const STORE_KEY = 'otica_flow_sales_v1';

  const loadLocal = () => {
    try {
      const data = localStorage.getItem(STORE_KEY);
      console.log('[v0] Relat√≥rio - carregando do localStorage:', data ? `${JSON.parse(data).length} vendas` : 'vazio');
      return data ? JSON.parse(data) : [];
    } catch (e) {
      console.error('[v0] Erro ao carregar localStorage:', e);
      return [];
    }
  };

  async function fetchFromDrive() {
    console.log('[v0] Relat√≥rio - iniciando carregamento...');
    
    // Primeiro, tenta carregar do localStorage
    const localData = loadLocal();
    console.log('[v0] Relat√≥rio - dados locais:', localData.length, 'vendas');
    
    try {
      console.log('[v0] Relat√≥rio - tentando buscar do Drive...');
      const r = await fetch(API_URL + "?t=" + Date.now(), {cache:"no-store"});
      
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}`);
      }
      
      const j = await r.json();
      console.log('[v0] Relat√≥rio - resposta do Drive:', j);
      
      if (j && j.ok && Array.isArray(j.data) && j.data.length > 0) {
        console.log('[v0] Relat√≥rio - usando dados do Drive:', j.data.length, 'vendas');
        return j.data;
      }
    } catch (e) {
      console.error('[v0] Relat√≥rio - erro ao buscar do Drive:', e);
    }
    
    // Fallback para localStorage
    console.log('[v0] Relat√≥rio - usando dados locais');
    return localData;
  }

  function calcSaleTotals(sale) {
    const totVenda = (sale.products||[]).reduce((a,p)=>a+(+p.price||0),0);
    const totCusto = (sale.products||[]).reduce((a,p)=>a+(+p.cost||0),0);
    const totTaxa  = (sale.products||[]).reduce((a,p)=>a+(+p.fee||0),0);
    const lucro = totTaxa - totCusto;
    return {totVenda, totCusto, totTaxa, lucro};
  }
  
  function sameMonth(d1, d2){
    const a = new Date(d1), b = new Date(d2);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth();
  }

  async function render(){
    const sales = await fetchFromDrive();
    console.log('[v0] Relat√≥rio - renderizando', sales.length, 'vendas');
    
    const rows = document.getElementById('rows');
    rows.innerHTML = '';

    // lista tudo; totais calculados s√≥ do m√™s atual
    const now = new Date();
    const monthSales = sales.filter(s=> s.date && sameMonth(s.date, now));

    for (const s of sales){
      const t = calcSaleTotals(s);
      const payStr = (s.payments||[]).map(p=>{
        const parc = p.installments ? ` ${p.installments}` : '';
        const det  = p.detail ? ` ${p.detail}` : '';
        return `${p.method}${parc}${det}: ${fmt.format(+p.amount||0)}`;
      }).join(' ‚Ä¢ ');
      const tr = document.createElement('tr');
      tr.className = 'border-t border-white/10';
      tr.innerHTML = `
        <td class="p-3">${s.date||''}</td>
        <td class="p-3">${s.os||''}</td>
        <td class="p-3">${(s.products||[]).map(p=>p.name).join(', ')}</td>
        <td class="p-3 text-right">${fmt.format(t.totCusto)}</td>
        <td class="p-3 text-right">${fmt.format(t.totVenda)}</td>
        <td class="p-3 text-right">${fmt.format(t.totTaxa)}</td>
        <td class="p-3 text-right">${fmt.format(t.lucro)}</td>
        <td class="p-3">${payStr}</td>`;
      rows.appendChild(tr);
    }

    const tVenda = sum(monthSales, s=>calcSaleTotals(s).totVenda);
    const tCusto = sum(monthSales, s=>calcSaleTotals(s).totCusto);
    const tTaxa  = sum(monthSales, s=>calcSaleTotals(s).totTaxa);
    const tLucro = tTaxa - tCusto;
    document.getElementById('tCusto').textContent = fmt.format(tCusto);
    document.getElementById('tVenda').textContent = fmt.format(tVenda);
    document.getElementById('tLucro').textContent = fmt.format(tLucro);
  }

  document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
  window.addEventListener('load', render);
</script>
</body>
</html>

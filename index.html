<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vendas Lite — Fabio</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --radius: 14px; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { border-radius: var(--radius); box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    .btn { border-radius: 999px; }
    .table-wrap { overflow: auto; }
    .pill { border-radius: 9999px; padding: 2px 10px; font-size: 12px; font-weight: 600; }
    .input { border-radius: 10px; }
    .sticky-th { position: sticky; top: 0; background: #fff; z-index: 1; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Vendas <span class="text-indigo-600">Lite</span></h1>
      <div class="flex items-center gap-2">
        <button id="exportCsv" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2">Exportar CSV</button>
        <label class="btn bg-white border px-4 py-2 cursor-pointer">Importar CSV
          <input id="importCsv" type="file" accept=".csv" class="hidden" />
        </label>
        <button id="resetAll" class="btn bg-white border px-4 py-2">Limpar tudo</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <!-- Formulário -->
    <section class="card bg-white p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Nova venda</h2>
      <form id="saleForm" class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <input id="produto" class="input border px-3 py-2 md:col-span-2" placeholder="Produto" required />
        <input id="custo" class="input border px-3 py-2" type="number" step="0.01" min="0" placeholder="Custo (R$)" required />
        <input id="preco" class="input border px-3 py-2" type="number" step="0.01" min="0" placeholder="Preço de venda (R$)" required />
        <div class="flex gap-2">
          <input id="taxa" class="input border px-3 py-2 w-full" type="number" step="0.01" min="0" max="100" placeholder="Taxa operadora (%)" />
        </div>
        <select id="forma" class="input border px-3 py-2" required>
          <option value="Crédito">Crédito</option>
          <option value="Débito">Débito</option>
          <option value="Pix">Pix</option>
          <option value="Dinheiro">Dinheiro</option>
        </select>
        <input id="data" class="input border px-3 py-2" type="date" required />
        <div class="md:col-span-6 flex items-center gap-3">
          <button class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2" type="submit">Adicionar</button>
          <div class="text-sm text-gray-500">Dica: se deixar a <em>Taxa</em> em branco, aplico padrão por forma de pagamento (Crédito 4.5%, Débito 2.2%, Pix/Dinheiro 0%).</div>
        </div>
      </form>
    </section>

    <!-- Filtros e resumo -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="card bg-white p-4">
        <h3 class="font-semibold mb-2">Filtros</h3>
        <div class="grid grid-cols-2 gap-2 mb-3">
          <input id="fDataIni" class="input border px-3 py-2" type="date" />
          <input id="fDataFim" class="input border px-3 py-2" type="date" />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input id="fBusca" class="input border px-3 py-2 col-span-2" placeholder="Buscar por produto/forma" />
          <select id="fForma" class="input border px-3 py-2 col-span-2">
            <option value="">Todas as formas</option>
            <option>Crédito</option>
            <option>Débito</option>
            <option>Pix</option>
            <option>Dinheiro</option>
          </select>
        </div>
      </div>
      <div class="card bg-white p-4">
        <h3 class="font-semibold mb-2">Resumo (filtrado)</h3>
        <ul class="space-y-1 text-sm">
          <li>Total de vendas: <span id="rVendas" class="font-semibold">0</span></li>
          <li>Receita bruta: <span id="rReceita" class="font-semibold">R$ 0,00</span></li>
          <li>Custos: <span id="rCustos" class="font-semibold">R$ 0,00</span></li>
          <li>Taxas: <span id="rTaxas" class="font-semibold">R$ 0,00</span></li>
          <li>Lucro líquido: <span id="rLucro" class="font-semibold">R$ 0,00</span></li>
          <li>Margem média: <span id="rMargem" class="font-semibold">0%</span></li>
        </ul>
      </div>
      <div class="card bg-white p-4">
        <h3 class="font-semibold mb-2">Atalhos</h3>
        <div class="flex gap-2 flex-wrap">
          <button class="btn border px-3 py-1" data-preset="hoje">Hoje</button>
          <button class="btn border px-3 py-1" data-preset="7d">Últimos 7 dias</button>
          <button class="btn border px-3 py-1" data-preset="30d">Últimos 30 dias</button>
          <button class="btn border px-3 py-1" data-preset="limpar">Limpar filtros</button>
        </div>
      </div>
    </section>

    <!-- Tabela -->
    <section class="card bg-white p-0">
      <div class="table-wrap">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="sticky-th p-3">#</th>
              <th class="sticky-th p-3">Produto</th>
              <th class="sticky-th p-3">Custo</th>
              <th class="sticky-th p-3">Preço</th>
              <th class="sticky-th p-3">Taxa (%)</th>
              <th class="sticky-th p-3">Taxa (R$)</th>
              <th class="sticky-th p-3">Forma</th>
              <th class="sticky-th p-3">Data</th>
              <th class="sticky-th p-3">Lucro (R$)</th>
              <th class="sticky-th p-3">Margem</th>
              <th class="sticky-th p-3">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ===== Util =====
    const R$ = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtPct = (v)=> `${(v||0).toFixed(1)}%`;
    const byId = (id)=> document.getElementById(id);

    // ===== Estado =====
    let vendas = JSON.parse(localStorage.getItem('vendasLite') || '[]');

    // ===== Regras de taxa padrão por forma =====
    const taxaPadrao = {
      'Crédito': 4.5,
      'Débito': 2.2,
      'Pix': 0,
      'Dinheiro': 0
    };

    // ===== Form submit =====
    byId('data').valueAsDate = new Date();

    byId('saleForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const produto = byId('produto').value.trim();
      const custo = parseFloat(byId('custo').value || '0');
      const preco = parseFloat(byId('preco').value || '0');
      const forma = byId('forma').value;
      const data = byId('data').value || new Date().toISOString().slice(0,10);
      let taxa = parseFloat(byId('taxa').value);
      if (isNaN(taxa)) taxa = taxaPadrao[forma] ?? 0;

      const taxaRS = preco * (taxa/100);
      const lucro = preco - custo - taxaRS;
      const margem = preco>0 ? (lucro/preco)*100 : 0;

      vendas.push({ id: crypto.randomUUID(), produto, custo, preco, taxa, taxaRS, forma, data, lucro, margem });
      localStorage.setItem('vendasLite', JSON.stringify(vendas));
      e.target.reset();
      byId('data').valueAsDate = new Date();
      render();
    });

    // ===== Render =====
    const tbody = byId('tbody');

    function render(){
      const { lista, resumo } = filtrar(vendas);
      tbody.innerHTML = '';
      lista.forEach((v, i)=>{
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `
          <td class="p-3 text-gray-500">${i+1}</td>
          <td class="p-3 font-medium">${escapeHtml(v.produto)}</td>
          <td class="p-3">${R$.format(v.custo)}</td>
          <td class="p-3">${R$.format(v.preco)}</td>
          <td class="p-3">${(v.taxa||0).toFixed(2)}</td>
          <td class="p-3">${R$.format(v.taxaRS)}</td>
          <td class="p-3"><span class="pill bg-gray-100">${v.forma}</span></td>
          <td class="p-3">${v.data}</td>
          <td class="p-3 font-semibold ${v.lucro>=0? 'text-emerald-600':'text-rose-600'}">${R$.format(v.lucro)}</td>
          <td class="p-3">${v.margem.toFixed(1)}%</td>
          <td class="p-3 space-x-2">
            <button class="text-indigo-600 hover:underline" data-edit="${v.id}">Editar</button>
            <button class="text-rose-600 hover:underline" data-del="${v.id}">Excluir</button>
          </td>`;
        tbody.appendChild(tr);
      });
      // Atualiza resumo
      byId('rVendas').textContent = resumo.qtd;
      byId('rReceita').textContent = R$.format(resumo.receita);
      byId('rCustos').textContent = R$.format(resumo.custos);
      byId('rTaxas').textContent = R$.format(resumo.taxas);
      byId('rLucro').textContent = R$.format(resumo.lucro);
      byId('rMargem').textContent = isFinite(resumo.margemMedia) ? `${resumo.margemMedia.toFixed(1)}%` : '0%';
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // ===== Filtros =====
    const fDataIni = byId('fDataIni');
    const fDataFim = byId('fDataFim');
    const fForma = byId('fForma');
    const fBusca = byId('fBusca');
    [fDataIni, fDataFim, fForma, fBusca].forEach(el=> el.addEventListener('input', render));

    document.querySelectorAll('[data-preset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const p = btn.dataset.preset;
        const today = new Date();
        if(p==='hoje'){
          const d = today.toISOString().slice(0,10);
          fDataIni.value = d; fDataFim.value = d;
        } else if(p==='7d'){
          const ini = new Date(today); ini.setDate(today.getDate()-6);
          fDataIni.value = ini.toISOString().slice(0,10);
          fDataFim.value = today.toISOString().slice(0,10);
        } else if(p==='30d'){
          const ini = new Date(today); ini.setDate(today.getDate()-29);
          fDataIni.value = ini.toISOString().slice(0,10);
          fDataFim.value = today.toISOString().slice(0,10);
        } else {
          fDataIni.value = ''; fDataFim.value = ''; fForma.value = ''; fBusca.value='';
        }
        render();
      });
    });

    function filtrar(src){
      const ini = fDataIni.value ? new Date(fDataIni.value) : null;
      const fim = fDataFim.value ? new Date(fDataFim.value) : null;
      const forma = fForma.value.trim().toLowerCase();
      const busca = fBusca.value.trim().toLowerCase();
      const lista = src.filter(v=>{
        const dv = new Date(v.data);
        if (ini && dv < ini) return false;
        if (fim && dv > new Date(fim.getTime()+86400000-1)) return false;
        if (forma && v.forma.toLowerCase()!==forma) return false;
        if (busca && !(v.produto.toLowerCase().includes(busca) || v.forma.toLowerCase().includes(busca))) return false;
        return true;
      });
      const resumo = lista.reduce((acc,v)=>{
        acc.qtd++;
        acc.receita += v.preco;
        acc.custos += v.custo;
        acc.taxas  += v.taxaRS;
        acc.lucro  += v.lucro;
        return acc;
      }, {qtd:0, receita:0, custos:0, taxas:0, lucro:0});
      resumo.margemMedia = resumo.receita>0 ? (resumo.lucro/resumo.receita)*100 : 0;
      return { lista, resumo };
    }

    // ===== Editar / Excluir =====
    tbody.addEventListener('click', (e)=>{
      const idDel = e.target.getAttribute('data-del');
      const idEdt = e.target.getAttribute('data-edit');
      if(idDel){
        vendas = vendas.filter(v=> v.id!==idDel);
        localStorage.setItem('vendasLite', JSON.stringify(vendas));
        render();
      }
      if(idEdt){
        const v = vendas.find(x=> x.id===idEdt);
        if(!v) return;
        const produto = prompt('Produto', v.produto);
        if(produto===null) return; // cancelou
        const custo = parseFloat(prompt('Custo (R$)', v.custo));
        const preco = parseFloat(prompt('Preço (R$)', v.preco));
        const taxa  = parseFloat(prompt('Taxa operadora (%)', v.taxa));
        const forma = prompt('Forma (Crédito/Débito/Pix/Dinheiro)', v.forma);
        const data  = prompt('Data (YYYY-MM-DD)', v.data);
        const taxaRS = (isNaN(preco)?0:preco) * ((isNaN(taxa)?0:taxa)/100);
        const lucro = (isNaN(preco)?0:preco) - (isNaN(custo)?0:custo) - taxaRS;
        const margem = (isNaN(preco)||preco===0) ? 0 : (lucro/preco)*100;
        Object.assign(v, {produto, custo, preco, taxa: isNaN(taxa)?0:taxa, taxaRS, forma, data, lucro, margem});
        localStorage.setItem('vendasLite', JSON.stringify(vendas));
        render();
      }
    });

    // ===== CSV Export/Import =====
    byId('exportCsv').addEventListener('click', ()=>{
      const headers = ['produto','custo','preco','taxa(%)','taxaRS','forma','data','lucro','margem(%)'];
      const rows = vendas.map(v=> [v.produto, v.custo, v.preco, v.taxa, v.taxaRS, v.forma, v.data, v.lucro, v.margem]);
      const csv = [headers.join(','), ...rows.map(r=> r.join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'vendas.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    byId('importCsv').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const lines = reader.result.split(/\r?\n/).filter(Boolean);
        const body = lines.slice(1); // pula header
        const parsed = body.map(l=> l.split(',')).filter(cols=> cols.length>=9).map(cols=>{
          const [produto,custo,preco,taxa,taxaRS,forma,data,lucro,margem] = cols;
          const p = {
            id: crypto.randomUUID(),
            produto,
            custo: parseFloat(custo)||0,
            preco: parseFloat(preco)||0,
            taxa: parseFloat(taxa)||0,
            taxaRS: parseFloat(taxaRS)||0,
            forma: forma||'Pix',
            data: data||new Date().toISOString().slice(0,10),
            lucro: parseFloat(lucro)||0,
            margem: parseFloat(margem)||0,
          };
          return p;
        });
        vendas = vendas.concat(parsed);
        localStorage.setItem('vendasLite', JSON.stringify(vendas));
        e.target.value = '';
        render();
      };
      reader.readAsText(file, 'utf-8');
    });

    // ===== Reset =====
    byId('resetAll').addEventListener('click', ()=>{
      if(confirm('Tem certeza que deseja limpar todos os dados?')){
        vendas = [];
        localStorage.setItem('vendasLite', JSON.stringify(vendas));
        render();
      }
    });

    render();
  </script>
</body>
</html>

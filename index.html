<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√ìtica Flow</title>
  <style>
    :root{ --bg:#fafafa; --card:#fff; --line:#e5e5e5; --muted:#666; --primary:#0b6; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#f7f7f7;color:#222}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}

    /* R√≥tulos com destaque (bold + ‚Äúbal√£o‚Äù com contorno) */
    label{
      display:inline-block;
      font-weight:700;
      font-size:12px;
      color:#333;
      margin:0 0 6px;
      padding:4px 8px;
      border:1px solid #ddd;
      border-radius:10px;
      background:#fff;
    }

    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;outline:none
    }
    textarea{resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid #ddd;background:#fff;color:#333;cursor:pointer}
    .btn.primary{border-color:var(--primary);background:var(--primary);color:#fff;font-weight:600}
    .btn.ghost{background:#fff}
    .btn.mini{padding:6px 8px;border-radius:6px}
    .btn.danger{border-color:#f33;color:#c00}
    table{width:100%;border-collapse:collapse}
    thead tr{background:#f8f8f8}
    th,td{text-align:left;padding:8px 10px;border-top:1px solid #eee;font-size:14px;vertical-align:top}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .stat{background:var(--card);border:1px solid #eee;border-radius:10px;padding:12px}
    .stat .label{color:#666;font-size:12px;margin-bottom:6px;font-weight:600}
    .stat .value{font-weight:700;font-size:18px}
    .tips{border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .tips button{width:100%;text-align:left;padding:12px 14px;background:#f6fbff;border:0;cursor:pointer;font-weight:600}
    .muted{color:#777}
    .pay-grid{display:grid;grid-template-columns:180px 160px 1fr auto;gap:8px;align-items:end}
    .pay-grid .head{font-size:12px;color:#444;margin-bottom:6px;font-weight:700;padding:4px 8px;border:1px solid #ddd;border-radius:10px;background:#fff;display:inline-block}
    @media (max-width:900px){ .pay-grid{grid-template-columns:1fr 1fr 1fr auto} }
    @media (max-width:800px){ .grid-2{grid-template-columns:1fr} .stats{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .stats{grid-template-columns:1fr} .pay-grid{grid-template-columns:1fr 1fr;} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>√ìtica Flow</h1>

    <!-- Formul√°rio -->
    <form id="form" class="card grid grid-2">
      <div>
        <label for="data">Data</label>
        <input id="data" type="date" required />
      </div>

      <div>
        <label for="cliente">Cliente</label>
        <input id="cliente" type="text" placeholder="Nome do cliente" />
      </div>

      <div style="grid-column:1/-1">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <label style="margin:0">Pagamentos (pode dividir em v√°rios m√©todos)</label>
          <button class="btn mini" type="button" id="addPay">+ Adicionar m√©todo</button>
        </div>
        <div class="pay-grid" id="payHead">
          <div class="head">Forma</div>
          <div class="head">Parcelamento</div>
          <div class="head">Valor recebido</div>
          <div class="head"></div>
        </div>
        <div id="payList"></div>
        <div style="margin-top:8px;color:#555;font-size:13px">
          <b>Recebido total:</b> <span id="recebidoTotal">R$ 0,00</span>
        </div>
      </div>

      <div>
        <label for="valorVenda">Valor da venda (bruto)</label>
        <input id="valorVenda" type="number" step="0.01" placeholder="0,00" />
      </div>

      <div>
        <label for="custo">Custo</label>
        <input id="custo" type="number" step="0.01" placeholder="0,00" />
      </div>

      <div>
        <label for="lucro">Lucro (autom√°tico)</label>
        <input id="lucro" type="text" readonly />
      </div>

      <div style="grid-column:1/-1">
        <label for="obs">Observa√ß√£o</label>
        <textarea id="obs" rows="2" placeholder="Notas da venda, n¬∫ da OS, etc."></textarea>
      </div>

      <div style="grid-column:1/-1" class="row">
        <button class="btn primary" type="submit" id="btnSubmit">Adicionar venda</button>
        <button class="btn ghost" type="button" id="btnCancel" style="display:none">Cancelar edi√ß√£o</button>
        <button class="btn ghost" type="button" id="btnCSV">Exportar CSV</button>
      </div>
    </form>

    <!-- Resumo -->
    <section style="margin-top:16px">
      <h3 style="margin:12px 0">Resumo</h3>
      <div class="stats">
        <div class="stat"><div class="label">Vendas (bruto)</div><div class="value" id="sumVendas">R$ 0,00</div></div>
        <div class="stat"><div class="label">Recebido (total)</div><div class="value" id="sumRecebido">R$ 0,00</div></div>
        <div class="stat"><div class="label">Custo</div><div class="value" id="sumCusto">R$ 0,00</div></div>
        <div class="stat"><div class="label">Lucro</div><div class="value" id="sumLucro">R$ 0,00</div></div>
      </div>
    </section>

    <!-- Lista -->
    <section style="margin-top:16px">
      <h3 style="margin:12px 0">Vendas lan√ßadas</h3>
      <div id="empty" class="card muted" style="display:none">Sem registros ainda.</div>
      <div class="card" id="tableWrap" style="padding:0;overflow:auto;display:none">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Cliente</th>
              <th>Pagamento(s)</th>
              <th>Venda</th>
              <th>Recebido</th>
              <th>Custo</th>
              <th>Lucro</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Dicas r√°pidas -->
    <section style="margin:20px 0 40px">
      <div class="tips">
        <button id="tipsToggle">üí° Dicas r√°pidas ‚ñº</button>
        <div id="tipsBody" style="display:none;padding:12px;background:#fff">
          <ul style="margin:0;padding-left:18px;line-height:1.6">
            <li>Use <b>‚Äú+ Adicionar m√©todo‚Äù</b> para dividir em dois cart√µes, ou combinar <b>PIX</b> + <b>Cr√©dito</b>, etc.</li>
            <li>Parcelamento s√≥ aparece quando a forma √© <b>Cr√©dito</b> (√Ä vista, 2x‚Äì10x).</li>
            <li><b>Recebido total</b> = soma dos m√©todos. <b>Lucro</b> = recebido total ‚àí custo.</li>
            <li>‚ÄúExportar CSV‚Äù gera um arquivo com os pagamentos detalhados em uma coluna.</li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <!-- JS igual ao v6 anterior (pagamentos m√∫ltiplos, migra√ß√£o, etc.) -->
  <script>
    const STORAGE_KEY_V5 = "otica_flow_orders_v5";
    const LEGACY_KEYS = ["otica_flow_orders_v4", "otica_flow_orders_v3"];
    const $ = (id) => document.getElementById(id);
    const currency = (n) => Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    function parseNum(v){ if (v === "" || v == null) return 0; const n = Number(String(v).replace(",", ".")); return isFinite(n) ? n : 0; }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function uuid(){ return crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + Date.now(); }

    function normalizePagamentos(o){
      if (Array.isArray(o.pagamentos) && o.pagamentos.length){
        return o.pagamentos.map(p=>({
          forma: ["Cr√©dito","D√©bito","PIX","Dinheiro"].includes(p.forma) ? p.forma : "Dinheiro",
          parcelamento: p.forma === "Cr√©dito" ? (p.parcelamento || "√Ä vista") : "",
          valor: parseNum(p.valor)
        }));
      } else {
        const forma = (o?.pagamento?.forma && ["Cr√©dito","D√©bito","PIX","Dinheiro"].includes(o.pagamento.forma)) ? o.pagamento.forma : "Dinheiro";
        const parcel = forma === "Cr√©dito" ? (o?.pagamento?.parcelamento || "√Ä vista") : "";
        let valor = parseNum(o.recebido ?? 0);
        if (!valor && o.taxa != null){
          const total = parseNum(o.valorVenda ?? o.total ?? 0);
          valor = total - parseNum(o.taxa);
        }
        return [{ forma, parcelamento: parcel, valor }];
      }
    }
    function migrateOrderToV6(o){
      const valorVenda = parseNum(o.valorVenda ?? o.total ?? 0);
      const custo = parseNum(o.custo ?? 0);
      const pagamentos = normalizePagamentos(o);
      const recebidoTotal = pagamentos.reduce((s,p)=>s + parseNum(p.valor), 0);
      const lucro = recebidoTotal - custo;
      return {
        id: o.id || uuid(),
        data: o.data || todayISO(),
        cliente: o.cliente || "",
        observacao: o.observacao || "",
        itens: Array.isArray(o.itens) ? o.itens : [],
        pagamentos,
        valorVenda,
        recebido: recebidoTotal,
        custo,
        lucro
      };
    }
    function loadOrders(){
      const raw = localStorage.getItem(STORAGE_KEY_V5);
      if (raw){
        try{
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr.map(migrateOrderToV6) : [];
        }catch{}
      }
      for (const k of LEGACY_KEYS){
        const lg = localStorage.getItem(k);
        if (lg){
          try{
            const arr = JSON.parse(lg);
            const migrated = Array.isArray(arr) ? arr.map(migrateOrderToV6) : [];
            localStorage.setItem(STORAGE_KEY_V5, JSON.stringify(migrated));
            return migrated;
          }catch{}
        }
      }
      return [];
    }
    function saveOrders(orders){ localStorage.setItem(STORAGE_KEY_V5, JSON.stringify(orders)); }

    let orders = [];
    let editingId = null;

    const payList = $("payList");
    const formaOpts = ["Cr√©dito","D√©bito","PIX","Dinheiro"];
    const parcelOpts = ["√Ä vista", ...Array.from({length:9}, (_,i)=>`${i+2}x`)];

    function addPaymentRow(p = { forma:"Dinheiro", parcelamento:"", valor:"" }){
      const rowId = uuid();
      const wrap = document.createElement("div");
      wrap.className = "pay-grid";
      wrap.dataset.rowId = rowId;

      const selForma = document.createElement("select");
      for (const f of formaOpts){
        const op = document.createElement("option"); op.value=f; op.textContent=f; selForma.appendChild(op);
      }
      selForma.value = p.forma || "Dinheiro";

      const selParc = document.createElement("select");
      function refillParc(){
        selParc.innerHTML = "";
        if (selForma.value === "Cr√©dito"){
          for (const x of parcelOpts){
            const op = document.createElement("option"); op.value=x; op.textContent=x; selParc.appendChild(op);
          }
          selParc.disabled = false; selParc.style.background="#fff";
          selParc.value = p.parcelamento || "√Ä vista";
        } else {
          const op = document.createElement("option"); op.value = ""; op.textContent = "‚Äî";
          selParc.appendChild(op);
          selParc.disabled = true; selParc.style.background="#f2f2f2";
        }
      }

      const inpValor = document.createElement("input");
      inpValor.type="number"; inpValor.step="0.01"; inpValor.placeholder="0,00";
      inpValor.value = p.valor ?? "";

      const btnDel = document.createElement("button");
      btnDel.type="button"; btnDel.className="btn mini danger"; btnDel.textContent="Remover";
      btnDel.addEventListener("click", ()=>{ wrap.remove(); updateRecebidoAndLucro(); });

      selForma.addEventListener("change", ()=>{ refillParc(); updateRecebidoAndLucro(); });
      selParc.addEventListener("change", ()=>{ updateRecebidoAndLucro(); });
      inpValor.addEventListener("input", ()=>{ updateRecebidoAndLucro(); });

      refillParc();
      wrap.appendChild(selForma);
      wrap.appendChild(selParc);
      wrap.appendChild(inpValor);
      wrap.appendChild(btnDel);
      payList.appendChild(wrap);

      updateRecebidoAndLucro();
    }

    function getPaymentsFromUI(){
      const rows = Array.from(payList.querySelectorAll(".pay-grid"));
      return rows.map(r=>{
        const [selForma, selParc, inpValor] = r.querySelectorAll("select, input");
        const forma = selForma.value;
        const parcelamento = (forma === "Cr√©dito") ? selParc.value : "";
        const valor = parseNum(inpValor.value);
        return { forma, parcelamento, valor };
      }).filter(p=>p.valor>0 || p.forma);
    }

    const sumVendas = $("sumVendas");
    const sumRecebido = $("sumRecebido");
    const sumCusto = $("sumCusto");
    const sumLucro = $("sumLucro");
    const tbody = $("tbody");
    const tableWrap = $("tableWrap");
    const empty = $("empty");
    const recebidoTotalEl = $("recebidoTotal");

    function pagamentosResumoStr(pagamentos){
      if (!Array.isArray(pagamentos) || !pagamentos.length) return "‚Äî";
      return pagamentos.map(p=>{
        const parc = p.forma === "Cr√©dito" ? ` (${p.parcelamento||"√Ä vista"})` : "";
        return `${p.forma}${parc}: ${currency(p.valor)}`;
      }).join(" ‚Ä¢ ");
    }

    function render(){
      const totals = orders.reduce((acc,o)=>{
        acc.vendas += Number(o.valorVenda||0);
        acc.recebido += Number(o.recebido||0);
        acc.custo += Number(o.custo||0);
        acc.lucro += Number((typeof o.lucro==="number")? o.lucro : (o.recebido||0)-(o.custo||0));
        return acc;
      },{vendas:0,recebido:0,custo:0,lucro:0});
      sumVendas.textContent = currency(totals.vendas);
      sumRecebido.textContent = currency(totals.recebido);
      sumCusto.textContent = currency(totals.custo);
      sumLucro.textContent = currency(totals.lucro);

      tbody.innerHTML = "";
      if (orders.length === 0){
        empty.style.display = "";
        tableWrap.style.display = "none";
      } else {
        empty.style.display = "none";
        tableWrap.style.display = "";
        for (const o of orders){
          const tr = document.createElement("tr");
          const payStr = pagamentosResumoStr(o.pagamentos);
          tr.innerHTML = `
            <td>${o.data || ""}</td>
            <td>${(o.cliente || "").replaceAll("<","&lt;")}</td>
            <td>${payStr}</td>
            <td>${currency(o.valorVenda)}</td>
            <td>${currency(o.recebido)}</td>
            <td>${currency(o.custo)}</td>
            <td style="font-weight:600">${currency(o.lucro ?? ((o.recebido||0)-(o.custo||0)))}</td>
            <td style="white-space:nowrap">
              <button class="btn mini" data-edit="${o.id}">Editar</button>
              <button class="btn mini danger" data-del="${o.id}">Excluir</button>
            </td>`;
          tbody.appendChild(tr);
        }
      }
    }

    const dataEl = $("data");
    const clienteEl = $("cliente");
    const valorEl = $("valorVenda");
    const custoEl = $("custo");
    const lucroEl = $("lucro");
    const obsEl = $("obs");
    const btnSubmit = $("btnSubmit");
    const btnCancel = $("btnCancel");

    function resetForm(){
      editingId = null;
      dataEl.value = todayISO();
      clienteEl.value = "";
      obsEl.value = "";
      valorEl.value = "";
      custoEl.value = "";
      lucroEl.value = currency(0);
      payList.innerHTML = "";
      addPaymentRow();
      btnSubmit.textContent = "Adicionar venda";
      btnCancel.style.display = "none";
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function updateRecebidoAndLucro(){
      const pagamentos = getPaymentsFromUI();
      const recebidoTotal = pagamentos.reduce((s,p)=>s+parseNum(p.valor),0);
      recebidoTotalEl.textContent = currency(recebidoTotal);
      const lucro = recebidoTotal - parseNum(custoEl.value);
      lucroEl.value = currency(lucro);
    }

    function loadToEdit(o){
      editingId = o.id;
      dataEl.value = o.data || todayISO();
      clienteEl.value = o.cliente || "";
      obsEl.value = o.observacao || "";
      valorEl.value = o.valorVenda ?? "";
      custoEl.value = o.custo ?? "";

      payList.innerHTML = "";
      const pays = Array.isArray(o.pagamentos) && o.pagamentos.length ? o.pagamentos : [{ forma:"Dinheiro", parcelamento:"", valor:o.recebido||0 }];
      for (const p of pays){ addPaymentRow({ forma:p.forma, parcelamento:p.parcelamento, valor:p.valor }); }

      updateRecebidoAndLucro();
      btnSubmit.textContent = "Salvar altera√ß√µes";
      btnCancel.style.display = "";
      window.scrollTo({top:0,behavior:"smooth"});
    }

    $("addPay").addEventListener("click", ()=> addPaymentRow());

    $("form").addEventListener("submit", (e)=>{
      e.preventDefault();
      const pagamentos = getPaymentsFromUI();
      const recebidoTotal = pagamentos.reduce((s,p)=>s + parseNum(p.valor), 0);
      const record = {
        id: editingId || uuid(),
        data: dataEl.value || todayISO(),
        cliente: clienteEl.value || "",
        observacao: obsEl.value || "",
        itens: [],
        pagamentos,
        valorVenda: parseNum(valorEl.value),
        recebido: recebidoTotal,
        custo: parseNum(custoEl.value),
      };
      record.lucro = record.recebido - record.custo;

      if (editingId){
        orders = orders.map(o => o.id === editingId ? record : o);
      } else {
        orders = [record, ...orders];
      }
      saveOrders(orders);
      render();
      resetForm();
    });

    btnCancel.addEventListener("click", resetForm);

    $("tbody").addEventListener("click", (e)=>{
      const editId = e.target.getAttribute("data-edit");
      const delId  = e.target.getAttribute("data-del");
      if (editId){
        const o = orders.find(x=>x.id === editId);
        if (o) loadToEdit(o);
      } else if (delId){
        if (confirm("Excluir esta venda?")){
          orders = orders.filter(x=>x.id !== delId);
          saveOrders(orders);
          render();
        }
      }
    });

    $("btnCSV").addEventListener("click", ()=>{
      const header = [
        "id","data","cliente",
        "pagamentos_detalhe",
        "valorVenda","recebido_total","custo","lucro","observacao"
      ];
      const lines = [header.join(",")];
      for (const o of orders){
        const detalhe = (o.pagamentos||[]).map(p=>{
          const parc = p.forma === "Cr√©dito" ? ` (${p.parcelamento||"√Ä vista"})` : "";
          return `${p.forma}${parc}: ${String(p.valor).replace(".",",")}`;
        }).join(" | ");
        const row = [
          o.id,
          o.data,
          String(o.cliente ?? "").replaceAll(","," "),
          detalhe.replaceAll(",",";"),
          String(o.valorVenda ?? 0).replace(".",","),
          String(o.recebido ?? 0).replace(".",","),
          String(o.custo ?? 0).replace(".",","),
          String((o.lucro ?? ((o.recebido||0)-(o.custo||0)))).replace(".",","),
          String(o.observacao ?? "").replaceAll(","," ")
        ];
        lines.push(row.join(","));
      }
      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const monthKey = new Date().toISOString().slice(0,7);
      a.download = `otica_flow_${monthKey}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    $("tipsToggle").addEventListener("click", ()=>{
      const body = $("tipsBody");
      const open = body.style.display !== "none";
      body.style.display = open ? "none" : "block";
      $("tipsToggle").textContent = open ? "üí° Dicas r√°pidas ‚ñº" : "üí° Dicas r√°pidas ‚ñ≤";
    });

    (function init(){
      $("data").value = todayISO();
      orders = loadOrders();
      saveOrders(orders);
      render();
      resetForm();
    })();
  </script>
</body>
</html>
